## MQTT


```Message Queuing Telemetry Transport```/消息队列遥测传输协议


一种基于**发布/订阅**（```publish/subscribe```）模式的“**轻量级**”通讯协议，该协议构建于TCP/IP协议上


最大优点在于，用极少的代码和有限的带宽，为连接远程设备提供实时可靠的消息服务

**低开销、低带宽占用的即时通讯协议**

使其在物联网、小型设备、移动应用等方面有较广泛的应用

![发布和订阅](https://pic4.zhimg.com/80/v2-8c518394020ae1ae8a14a8caf85d56fb_720w.webp)

### 特点

1. 轻量高效，节省带宽

2. 可靠的消息传递QoS

3. 海量连接支持

    适合IoT物联网场景

4. 安全的双向通信

    * 支持通过 TLS/SSL 确保安全的双向通信
    * 同时 MQTT 协议中提供的客户端 ID、用户名和密码允许我们实现应用层的身份验证和授权

5. 在线状态感知

    * 心跳保活（Keep Alive）机制

    * 遗愿（Last Will） 消息


### 架构

![image](https://img2023.cnblogs.com/blog/999484/202308/999484-20230819182603124-1609685422.png)


* 发布者

* 订阅者

* Broker



***

![image](https://img2023.cnblogs.com/blog/999484/202308/999484-20230820000330449-1858315992.png)

* server

    服务器分发消息，因此必须是**发布者**，但绝不是订阅者！

* Client

    客户端可以发布消息（发送方）、订阅消息（接收方）或两者兼而有之


### 主题

消息在允许过滤的主题下发布。主题是分层划分的 UTF-8 字符串。不同的主题级别用斜杠/作为分隔符号

类似路由的概念

```
chat/room/1
sensor/10/temperature
sensor/+/temperature
sensor/#
```

⭐为了避免歧义且易于理解，通常不建议主题以 ```/``` 开头或结尾，例如 ```/chat 或 chat/```


1. 主题通配符

主要用于客户端一次订阅多个主题

* 单层通配符 ```+``` 

    ```
    + 有效
    sensor/+ 有效
    sensor/+/temperature 有效
    sensor+ 无效（没有占据整个层级）
    ```

* 多层通配符 ```#```

    它必须占据整个层级并且必须是主题的最后一个字符，例如：

    ```
    # 有效，匹配所有主题
    sensor/# 有效
    sensor/bedroom# 无效（没有占据整个层级）
    sensor/#/temperature 无效（不是主题最后一个字符）
    ```

* ```$```主题

    * 系统主题```$SYS/```

    系统主题主要用于获取 MQTT 服务器自身运行状态、消息统计、客户端上下线事件等数据

    * 共享订阅```$share```
    

### QoS

1. ```QoS 0``` 消息最多传递一次

如果当时客户端不可用，则会丢失该消息。发布者发送一条消息之后，就不再关心它有没有发送到对方，也不设置任何重发机制

![Qos0](https://pic3.zhimg.com/80/v2-dba21bbc002168f2e53ae469cd30c79a_720w.webp)

2. QoS 1

包含了简单的重发机制，发布者发送消息之后等待接收者的 ACK，如果没收到 ACK 则重新发送消息。这种模式能保证消息至少能到达一次，但**无法保证消息重复**

3. QoS 2

**保证消息仅传送到目的地一次**。

设计了重发和重复消息发现机制，保证消息到达对方并且严格只到达一次。

为此，带有唯一消息 ID 的消息会存储两次，首先来自发送者，然后是接收者。QoS 级别 2 在网络中具有最高的开销，因为在发送方和接收方之间需要两个流。

### MQTT 数据包结构

1. 固定头（```Fixed header```）

存在于所有MQTT数据包中，表示数据包类型及数据包的分组类标识；


2. 可变头（```Variable header```）

存在于部分MQTT数据包中，数据包类型决定了可变头是否存在及其具体内容；


3. 消息体（```Payload```）

存在于部分MQTT数据包中，表示客户端收到的具体内容

![数据包结构](https://pic3.zhimg.com/80/v2-861c089bea9570876bb13a031e6c3902_720w.webp)


## Mqtt Broker中间件

1. EMQ

2. Mosquitto


### 开源技术方案

1. MQTTnet

2. MqttDotNet

3. nMQTT

4. M2MQTT

### MQ教程

* [MQTT 教程](https://www.emqx.com/zh/mqtt-guide)

