## MQTT持久会话

不稳定的网络及有限的硬件资源是物联网应用需要面对的两大难题，MQTT 客户端与服务器的连接可能随时会因为网络波动及资源限制而异常断开。为了解决网络连接断开对通信造成的影响，MQTT 协议提供了持久会话功能。

持久会话主要有以下三个作用：

1. 避免因网络中断导致需要反复订阅带来的额外开销。

2. 避免错过离线期间的消息。

3. 确保 QoS 1 和 QoS 2 的消息质量保证不被网络中断影响。


### Clean Session

Clean Session 是用来控制会话状态生命周期的标志位

* 为 true 时表示创建一个新的会话，在客户端断开连接时，会话将自动销毁。

* 为 false 时表示创建一个持久会话，在客户端断开连接后会话仍然保持，直到会话超时注销。

⭐持久会话能被恢复的前提是客户端使用固定的 Client ID 再次连接，如果 Client ID 是动态的，那么连接成功后将会创建一个新的持久会话。

防止一直连接，可以设置**超时时间**,**最大消息数**和b保存消息的**QoS**

### Keep Alive

保活周期是一个以秒为单位的时间间隔。客户端在无报文发送时，将按 Keep Alive 设定的值定时向服务端发送心跳报文，确保连接不被服务端断开。

**半连接**，是指某一方的连接已经断开或者没有建立，而另外一方的连接却依然维持着。在这种情况下，半连接的一方可能会持续不断地向对端发送数据，而显然这些数据永远到达不了对端。为了避免半连接导致的通信黑洞，MQTT 协议提供了 Keep Alive 机制，使客户端和 MQTT 服务器可以判定当前是否存在半连接问题，从而关闭对应连接。


⭐启用 Keep Alive
客户端在创建和 MQTT Broker 的连接时，只要将连接请求协议包内的 Keep Alive **可变头部字段**设置为**非 0 值**，就可以在通信双方间启用 Keep Alive 机制。 Keep Alive 为 0~65535 的一个整数，代表客户端发送两次 MQTT 协议包之间的**最大间隔时间**。


### Will Message

**遗嘱消息**是 MQTT 为那些可能出现 意外断线 的设备提供的将 遗嘱 优雅地发送给第三方的能力。意外断线包括但不限于：

1. 因网络故障或网络波动，设备在保持连接周期内未能通讯，连接被服务端关闭
2. 设备意外掉电
3. 设备尝试进行不被允许的操作而被服务端关闭连接，例如订阅自身权限以外的主题等



遗嘱消息会在设备与服务端连接时，通过 CONNECT 报文指定，然后在设备意外断线时由服务端将该遗嘱消息发布到连接时指定的遗嘱主题（Will Topic）上。这也意味着服务端必须在回复 CONNACK 之前完成遗嘱消息的存储，以确保之后任一时刻发生意外断线的情况，服务端都能保证遗嘱消息被发布。


### Retained Message

**保留消息**,Retained 标记被设置为 ```true```

MQTT 服务器会为每个主题存储最新一条保留消息，以方便消息发布后才上线的客户端在订阅主题时仍可以接收到该消息


