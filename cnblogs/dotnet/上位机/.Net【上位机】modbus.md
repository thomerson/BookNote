## modbus

这种协议最早被用在PLC控制器中，准确的说是Modicon公司的PLC控制器，这也是Mod-Bus名称的由来。后来Modicon被施耐德（Schneider）收购，Modbus协议广泛应用在工业控制器、HMI和传感器上，逐渐被其他厂商所接受，成为了一种主流的通讯协议，**用于和外围设备进行通讯**


### 主从通信

modbus使用**主从通讯技术**，即由主设备主动查询和操作从设备

一般将主控设备方（上位机）所使用的协议称为**Modbus Master**，从设备方（设备）使用的协议称为**Modbus Slave**

Master端也可以直接发消息修改Slave端的数据，实现**双向读写**

典型的主设备包括工控机和工业控制器等;典型的从设备如PLC可编程控制器等

### modbus分层

![image](https://img2023.cnblogs.com/blog/999484/202308/999484-20230806111912120-1488547946.png)

Modbus在7层OSI参考模型中属于第七层应用层，数据链路层有两种：基于标准串口协议和TCP协议，物理层可使用3线232、2线485、4线422，或光纤、网线、无线等多种传输介质


### Modbus消息帧

![image](https://img2023.cnblogs.com/blog/999484/202308/999484-20230806101154680-1817084238.png)


- ADU ****应用数据单元****
- PDU ****协议数据单元****

1. 4个存储区



2. 常用功能码

    ![image](https://img2023.cnblogs.com/blog/999484/202308/999484-20230806104603147-294195497.png)

    重要的功能码
    * ```01``` 读线圈寄存器（读）
    * ```03``` 读保持寄存器（读）
    * ```04``` 读输入寄存器（写）
    * ```05``` 写单个线圈寄存器（写）



3. 模式

    ![image](https://img2023.cnblogs.com/blog/999484/202308/999484-20230806101527697-84782792.png)


    * ASCII

      在消息中的每个8Bit 字节都作为两个ASCII字符发送

      LRC(纵向冗长检测)

    * RTU/```Remote Terminal Unit```

      远程终端单元

      直接发送数据，二进制代码

      十六进制表示数据的方式

      CRC(循环冗长检测)

      串行通信

    * TCP 

      这种模式**不使用校验**，因为TCP协议是一个面向连接的可靠协议

    * Modbus Plus

      施耐德电气的专利变体，与其他类型的变体相比，它支持各种主站之间的点对点类型的通信。

      需要一个专门的协处理器来处理类似HDLC的高速令牌旋转


4. 校验

    1. LRC(纵向冗长检测)


    2. crc校验

      ```Cyclic Redundancy Check```/循环冗余校验

      一种根据网络数据包或计算机文件等数据产生简短固定位数校验码的一种信道编码技术，主要用来检测或校验数据传输或者保存后可能出现的错误。 


      <br>利用**除法及余数**的原理来作错误侦测的</br>

      <br>从检错的正确率与速度、成本等方面，都比**奇偶校验**等校验方式具有优势。</br>

5. 具体协议

    ![image](https://img2023.cnblogs.com/blog/999484/202308/999484-20230806112103963-1901838342.png)

    RS232，RS485是一种电平标准

    RS 推荐标准 不是通讯协议

    数据在通信双方之间传输，**本质是传输物理的电平** 比方说传输5V的电压 -1V的电压信号，这些物理信号在传输过程中会受到很多干扰，比方说你传输一个5V的电压，到了接收端可能就变成了4.8V，并且通信的双方高低电平的参考电压可能不同。

    **那么这个时候就需要一个电平标准，来判断多少V的电压是高电平 1，多少V的电压是低电平 0 这就诞生了 RS-485 RS-232**

  * RS232

  * RS422

  * RS485

    485总线接线图

    ![image](https://img2023.cnblogs.com/blog/999484/202308/999484-20230806112000555-442764913.png)

    RS485总线要采用上图手拉手式的总线结构，坚决杜绝星型连接和分叉连接

    ![image](https://img2023.cnblogs.com/blog/999484/202308/999484-20230806112035580-1510254146.png)


* TCP/IP



## NModbus4

1. 安装nuget包

```install-package NModbus4```



2. 模拟器

* modbus slave
  
  modbus模拟软件

* Configure vitual serial port driver




